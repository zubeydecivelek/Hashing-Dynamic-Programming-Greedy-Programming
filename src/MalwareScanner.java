import java.io.*;
import java.util.Map;

/**
 * This class accomplishes Mission Firewall
 */
public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    /**
     * TODO: Open and read the input file while searching for threats
     * TODO: Write results to both; a new file name "scanLog.txt" and to the console
     *
     * @param filename the input file
     * @throws IOException the io exception
     */
    public void scanFile(String filename) throws IOException {

        BufferedWriter writer = new BufferedWriter(new FileWriter("scanLog.txt"));

        BufferedReader bufferedReader = new BufferedReader(new FileReader(filename));
        String line;
        int lineNumber = 1, malwareCount = 0;
        System.out.println("Started scanning...\n--------------------------------------------------------------------------------");
        while ((line=bufferedReader.readLine()) != null){
            String code = turbo64(line);

            if (malwareDB.get(code) != null){
                System.out.println("Detected malware!");
                System.out.println(malwareDB.get(code));
                System.out.println("--------------------------------------------------------------------------------");
                malwareCount++;
                writer.write(code + "@" + lineNumber + "\n");
            }

            lineNumber++;
        }
        System.out.println("Scan complete! " + malwareCount + " threats are found and eliminated. Generating log file...");
        writer.close();
    }

    public static String turbo64(String in) {
        long mod_turbo = 4294967291L;
        long a = 0, b = 1;
        char[] charArray = in.toCharArray();

        for (char c : charArray){
            a = (a + (int)c) % mod_turbo;
            b = (a + b) % mod_turbo;
        }

        return Long.toHexString((b << 32) | a);
    }
}
